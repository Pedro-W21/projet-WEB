<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner de Code-Barres</title>
    
    <!-- Librairies externes -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        img { max-width: 100%; display: block; margin: auto; }
        #cropper-container { max-width: 300px; margin: auto; display: none; }
        #preview { max-width: 300px; display: none; margin: auto; }
    </style>
</head>
<body>

    <h2>Scanner un Code-Barres</h2>

    <!-- Choix entre prendre une photo ou uploader une image -->
    <button id="takePhoto"> Prendre une photo</button>
    <input type="file" id="uploadImage" accept="image/*">
    
    <!-- Zone de capture vidéo -->
    <video id="camera" autoplay style="display: none;"></video>
    <button id="capture" style="display: none;"> Capturer</button>

    <!-- Zone de rognage -->
    <div id="cropper-container">
        <img id="imageToCrop">
        <button id="crop"> Rogner et Scanner</button>
    </div>

    <!-- Affichage du résultat -->
    <img id="preview">
    <p id="barcodeResult"></p>

    <!-- Informations sur le produit -->
    <h3>Informations sur le produit :</h3>
    <div id="productInfo">
        <p><strong>Nom :</strong> <span id="productName">N/A</span></p>
        <p><strong>Marque :</strong> <span id="productBrand">N/A</span></p>
        <p><strong>Catégorie :</strong> <span id="productCategory">N/A</span></p>
        <img id="productImage" style="max-width: 200px; display: none;">
    </div>

    <script>
        const codeReader = new ZXing.BrowserBarcodeReader();
        let cropper;

        // Prendre une photo avec la caméra
        document.getElementById('takePhoto').addEventListener('click', function() {
            const video = document.getElementById('camera');
            const captureButton = document.getElementById('capture');
            
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    video.style.display = "block";
                    captureButton.style.display = "block";
                })
                .catch(error => console.error("Erreur d'accès à la caméra :", error));
        });

        // Capturer une image depuis la caméra
        document.getElementById('capture').addEventListener('click', function() {
            const video = document.getElementById('camera');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const imageUrl = canvas.toDataURL('image/png');
            video.srcObject.getTracks().forEach(track => track.stop()); // Stoppe la caméra

            initCropper(imageUrl);
        });

        // Upload d'une image depuis le stockage
        document.getElementById('uploadImage').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function() {
                    initCropper(reader.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // Initialisation du CropperJS
        function initCropper(imageSrc) {
            const imageElement = document.getElementById('imageToCrop');
            imageElement.src = imageSrc;
            
            document.getElementById('cropper-container').style.display = "block";
            if (cropper) cropper.destroy();
            cropper = new Cropper(imageElement, {
                aspectRatio: 16 / 9, // Ajuste le format
                viewMode: 2
            });
        }

        // Rogner et scanner l'image
        document.getElementById('crop').addEventListener('click', function() {
            const croppedCanvas = cropper.getCroppedCanvas();
            const croppedImageUrl = croppedCanvas.toDataURL('image/png');

            document.getElementById('preview').src = croppedImageUrl;
            document.getElementById('preview').style.display = "block";

            scanBarcode(croppedImageUrl);
        });

        // Scanner un code-barres
        function scanBarcode(imageSrc) {
            const img = new Image();
            img.src = imageSrc;
            img.onload = function () {
                codeReader.decodeFromImage(img)
                    .then(result => {
                        document.getElementById("barcodeResult").innerText = "Code-barre détecté : " + result.text;
                        fetchProductInfo(result.text);
                    })
                    .catch(err => {
                        console.error("Erreur de détection :", err);
                        document.getElementById("barcodeResult").innerText = "Aucun code-barre détecté.";
                    });
            };
        }

        // Obtenir les informations du produit
        function fetchProductInfo(barcode) {
            fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 1) {
                        const productData = {
                            name: data.product.product_name || "Inconnu",
                            brand: data.product.brands || "Inconnu",
                            category: data.product.categories || "Inconnu",
                            image: data.product.image_url || null
                        };

                        document.getElementById("productName").innerText = data.product.product_name || "Inconnu";
                        document.getElementById("productBrand").innerText = data.product.brands || "Inconnu";
                        document.getElementById("productCategory").innerText = data.product.categories || "Inconnu";
                        if (data.product.image_url) {
                            document.getElementById("productImage").src = data.product.image_url;
                            document.getElementById("productImage").style.display = "block";
                        } else {
                            document.getElementById("productImage").style.display = "none";
                        }
                        sendDataToParent(productData.name); //à modifier
                    } else {
                        document.getElementById("productName").innerText = "Produit non trouvé";
                        document.getElementById("productBrand").innerText = "N/A";
                        document.getElementById("productCategory").innerText = "N/A";
                        document.getElementById("productImage").style.display = "none";
                    }
                })
                .catch(error => console.error("Erreur API :", error));
        }

        function sendDataToParent(productName) {
            if (window.opener) {
                window.opener.postMessage({ name: productName }, "*"); // Envoi des données
                //window.close(); // Ferme la popup après envoi
            } else {
                alert("Impossible d'envoyer les données, la fenêtre principale est introuvable.");
            }
        }
    </script>

</body>
</html>
